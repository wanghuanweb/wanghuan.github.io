function Questionaire(){this.init(),this.strPage=""}Questionaire.prototype={init:function(){var a,b,c,d;switch(console.log("init Questionaire & IDB",this),a=indexedDB.open("Questionaire",1),a.onerror=function(a){alert("创建/打开数据库失败，失败MSG："+a.target.error.message)},a.onupgradeneeded=function(a){var b=a.target.result,c=b.createObjectStore("myQuestionaire",{keyPath:"subject"});c.createIndex("count","count",{unique:!1}),c.createIndex("date","date",{unique:!1}),c.createIndex("state","state",{unique:!1}),c.createIndex("allData","allData",{unique:!1}),c.createIndex("time","time",{unique:!0})},b=window.location.href,c=b.split("/"),d=c[c.length-1],this.strPage=d.slice(0,d.indexOf(".")),this.strPage){case"edit":this.edit.init();break;case"index":this.index.init();break;case"write":this.write.init();break;case"detail":this.detail.init()}},detail:{init:function(){console.log("init detail page"),this.requestInfo=decodeURI(location.search.substring(9)),this.DBtoOBJ()},DBtoOBJ:function(){var b,a=indexedDB.open("Questionaire",1);a.onerror=function(a){alert("创建/打开数据库失败，失败MSG："+a.target.error.message)},b=this,a.onsuccess=function(a){var c,d,e;db=a.target.result,c=db.transaction("myQuestionaire","readwrite"),d=c.objectStore("myQuestionaire"),e=d.get(b.requestInfo),e.onsuccess=function(){b.OBJtoOBJ(e.result)}}},OBJtoOBJ:function(a){var b,c,e,d,f,g,h,i,j,k,l,m;for(this.currentObj=a,b=[],c=[],d="",e=0;e<a.allData.length;e++){switch(f=[],a.allData[e].type){case"radio":d+="<div class='detail-box'><div><span>"+a.allData[e].name+"</span><span>单选题</span><div id='"+a.allData[e].name+"' class='echart''>";break;case"checkbox":d+="<div class='detail-box'><div><span>"+a.allData[e].name+"</span><span>多选题</span><div id='"+a.allData[e].name+"' class='echart''>";break;case"textarea":d+="<div class='detail-box'><div><span>"+a.allData[e].name+"</span><span>文本题</span><div id='"+a.allData[e].name+"' class='echart''>"}for(g=[],h=0;h<a.allData[e].data.length;h++)g.push(this.calculatePersent(a.allData[e].data[h].count,a.count)),f.push(a.allData[e].data[h].content);c.push(f),b.push(g),d+="</div></div></div>"}for(document.getElementById("page_subject").innerHTML=this.requestInfo,document.getElementById("content_area").innerHTML=d,j=0;j<a.allData.length;j++){switch(i="Q"+(j+1),k=a.allData[j].subject,l="该问卷总提交数"+a.count+"次",m=echarts.init(document.getElementById(i)),option={baseOption:{title:{text:k,subtext:l,left:"1%"},color:["#f97a4b"],tooltip:{trigger:"axis",axisPointer:{type:"shadow"},position:["50%","50%"]},grid:{containLabel:!0,right:"10%"},xAxis:[{type:"category",data:c[j],axisTick:{alignWithLabel:!0}}],yAxis:[{type:"value",axisLabel:{show:!0,interval:"auto",formatter:"{value} %"}}],series:[{name:"直接访问",type:"bar",barWidth:"30%",data:b[j]}]},media:[{option:{grid:{left:"3%",right:"4%",bottom:"3%"},series:[{}]}}]},a.allData[j].type){case"radio":case"checkbox":option.baseOption.series[0].name="被选择的比例";break;case"textarea":option.baseOption.series[0].name="该文本题的有效率"}m.setOption(option)}},calculatePersent:function(a,b){var c=(100*(Number(a)/Number(b))).toFixed(2);return isNaN(c)?c="数据不够,请先填写数据！":c}},write:{init:function(){console.log("init write page"),this.requestInfo=decodeURI(location.search.substring(9)),this.DBtoOBJ(),this.currentObj={}},DBtoOBJ:function(){var b,a=indexedDB.open("Questionaire",1);a.onerror=function(a){alert("创建/打开数据库失败，失败MSG："+a.target.error.message)},b=this,a.onsuccess=function(a){var c,d,e;db=a.target.result,c=db.transaction("myQuestionaire","readwrite"),d=c.objectStore("myQuestionaire"),e=d.get(b.requestInfo),e.onsuccess=function(){b.OBJtoHTML(e.result)}}},OBJtoHTML:function(a){var b,c,d;for(this.currentObj=a,b="",c=0;c<a.allData.length;c++){switch(a.allData[c].type){case"radio":b+="<div class='questions'><div class='radio'><span>"+a.allData[c].name+"</span><span>单选题</span><span class='subject'>"+a.allData[c].subject+"</span></div><div>";break;case"checkbox":b+="<div class='questions'><div class='checkbox'><span>"+a.allData[c].name+"</span><span>多选题</span><span class='subject'>"+a.allData[c].subject+"</span></div><div>";break;case"textarea":b+="<div class='questions'><div class='textarea'><span>"+a.allData[c].name+"</span><span>文本题</span><span class='subject'>"+a.allData[c].subject+"</span></div><div>"}for(d=0;d<a.allData[c].data.length;d++)switch(a.allData[c].type){case"radio":b+="<div class='radios'><input type='radio' name='"+a.allData[c].data[d].randomNumberId+"' ><span>"+a.allData[c].data[d].content+"</span></div>";break;case"checkbox":b+="<div class='checkboxs'><input type='checkbox' ><span>"+a.allData[c].data[d].content+"</span></div>";break;case"textarea":b+="true"==a.allData[c].data[d].status?"<span class='true'>此题必填</span> <div><textarea cols='20' rows='10' placeholder='请填写你的回答' class='textareas' ></textarea></div>":"<span class='false'>此题选填</span> <div><textarea cols='20' rows='10' placeholder='请填写你的回答' class='textareas' ></textarea></div>"}b+="</div></div>"}document.getElementById("page_subject").innerHTML=this.requestInfo,document.getElementById("content_area").innerHTML=b},putDataToDB:function(){var b,c,a=indexedDB.open("Questionaire",1);a.onerror=function(a){alert("创建/打开数据库失败，失败MSG："+a.target.error.message)},c=this,a.onsuccess=function(a){b=a.target.result;var d=b.transaction("myQuestionaire","readwrite");store=d.objectStore("myQuestionaire"),store.put({count:c.currentObj.count,subject:c.currentObj.subject,date:c.currentObj.date,state:c.currentObj.state,allData:c.currentObj.allData,time:c.currentObj.time}),alert("问卷提交成功，1秒后自动跳转到主页。"),setTimeout(function(){window.location.href="index.html"},1500)}},saveObj:function(){var c,d,e,f,g,a=document.getElementsByClassName("questions"),b="";for(d=0;d<a.length;d++)switch(b=a[d].firstElementChild.className){case"radio":for(e=a[d].getElementsByClassName("radios"),c=0;c<e.length;c++)e[c].firstElementChild.checked&&this.currentObj.allData[d].data[c].count++;break;case"checkbox":for(f=a[d].getElementsByClassName("checkboxs"),c=0;c<f.length;c++)f[c].firstElementChild.checked&&this.currentObj.allData[d].data[c].count++;break;case"textarea":if(g=a[d].getElementsByTagName("textarea")[0],"true"===g.parentNode.previousElementSibling.className&&""===g.value)break;this.currentObj.allData[d].data[0].content=g.value,this.currentObj.allData[d].data[0].count++}this.currentObj.count++,this.putDataToDB()}},index:{init:function(){this.renderTbody(),this.needDeleteArr=[],console.log("init index page")},toggleMask:function(a){var e,f,b=a||window.event,c=b.target||b.srcElement,d=document.getElementById("maskControl").className;if(document.getElementById("maskControl").className="show"===d?"hide":"show","delete_some"==c.id){for(e=document.getElementById("checkBox").getElementsByClassName("checked"),f=0;f<e.length;f++)this.needDeleteArr.push(e[f].lastElementChild.id);return this.needDeleteArr}return this.needDeleteArr.push(c.parentNode.id),this.needDeleteArr},toggleCheck:function(a){var b=a||window.event,c=b.target||b.srcElement;c.checked?c.parentNode.parentNode.className="checked":(document.getElementById("checkAll").checked&&(document.getElementById("checkAll").checked=""),c.parentNode.parentNode.className="")},checkAll:function(a){var e,b=a||window.event,c=b.target||b.srcElement,d=document.getElementsByName("myQN");if(c.checked)for(e=0;e<d.length;e++)d[e].checked="checked",d[e].parentNode.parentNode.className="checked";else for(e=0;e<d.length;e++)d[e].checked="",d[e].parentNode.parentNode.className=""},renderTbody:function(){var b="",c=0,a=indexedDB.open("Questionaire",1),d=this;a.onsuccess=function(){var a=this.result,e=a.transaction("myQuestionaire","readwrite"),f=e.objectStore("myQuestionaire"),g=f.openCursor(),h="",i="",j="";g.onsuccess=function(a){var g,k,e=a.target.result;if(e){switch(e.value.state){case"-1":h="未发布",i="unpub",j="<a href='edit.html?subject="+encodeURI(e.value.subject)+"'><input type='button' value='编辑问卷'></a><input type='button' value='删除问卷' onclick='myQuestionaire.index.toggleMask(event)'>";break;case"0":h="发布中",i="pubing",j="<a href='write.html?subject="+encodeURI(e.value.subject)+"'><input type='button' value='填写数据'></a><a href='detail.html?subject="+encodeURI(e.value.subject)+"'><input type='button' value='查看数据'></a>";break;case"1":h="已结束",i="pubed",j="<a href='detail.html?subject="+encodeURI(e.value.subject)+"'><input type='button' value='查看数据'></a><input type='button' value='删除问卷' onclick='myQuestionaire.index.toggleMask(event)'>"}d.getTimeCompare(e.value.date)&&(g=e.value.subject,k=f.get(g),k.onsuccess=function(a){var b=a.target.result;b.state="1",f.put(b)}),b+="<tr><td><input type='checkbox' name='myQN' onchange='myQuestionaire.index.toggleCheck(event)' ></td><td>"+e.value.subject+"</td><td>"+e.value.date+"</td><td class='"+i+"'>"+h+"</td><td id="+e.value.subject+">"+j+"</td></tr>",c++,e.continue()}else 0===c&&(alert("还没有问卷，先去创建吧！将自动跳转至新建页面。"),window.location.href="add.html"),document.getElementById("checkBox").innerHTML=b}}},getTimeCompare:function(a){var b=a.replace(/-/g,"/"),c=new Date,d=c.getFullYear(),e=c.getMonth()+1,f=c.getDate(),g=d+"/"+e+"/"+f,h=new Date(b),i=new Date(g);return h.getTime()>=i.getTime()?!1:!0},deleteQuestionaire:function(){var a=indexedDB.open("Questionaire",1),b=this;a.onsuccess=function(){var e,f,a=this.result,c=a.transaction("myQuestionaire","readwrite"),d=c.objectStore("myQuestionaire");for(e=0;e<b.needDeleteArr.length;e++)f=d.delete(b.needDeleteArr[e]),f.onsuccess=function(){b.renderTbody()};document.getElementById("maskControl").className="hide",document.getElementById("checkAll").checked&&(document.getElementById("checkAll").checked="")}}},edit:{init:function(){this.requestInfo=decodeURI(location.search.substring(9)),""!==this.requestInfo&&this.DBtoOBJ(),console.log("init edit page")},DBtoOBJ:function(){var b,a=indexedDB.open("Questionaire",1);a.onerror=function(a){alert("创建/打开数据库失败，失败MSG："+a.target.error.message)},b=this,a.onsuccess=function(a){var c,d,e;db=a.target.result,c=db.transaction("myQuestionaire","readwrite"),d=c.objectStore("myQuestionaire"),e=d.get(b.requestInfo),e.onsuccess=function(){b.OBJtoHTML(e.result)}}},OBJtoHTML:function(a){var c,d,b="";for(c=0;c<a.allData.length;c++){switch(a.allData[c].type){case"radio":b+="<div class='questions'><div class='radio'><span>"+a.allData[c].name+"</span><span>单选题</span><input type='text' class='subject' placeholder='单选标题' value='"+a.allData[c].subject+"'></div><div>";break;case"checkbox":b+="<div class='questions'><div class='radio'><span>"+a.allData[c].name+"</span><span>多选题</span><input type='text' class='subject' placeholder='多选标题' value='"+a.allData[c].subject+"'></div><div>";break;case"textarea":b+="<div class='questions'><div class='textarea'><span>"+a.allData[c].name+"</span><span>文本题</span><input type='text' class='subject' placeholder='文本标题' value='"+a.allData[c].subject+"'></div><div>"}for(d=0;d<a.allData[c].data.length;d++)switch(a.allData[c].type){case"radio":b+="<div class='radios'><input type='radio' name='"+Math.random()+"'  disabled='disabled'><input type='text' placeholder='单选内容' value='"+a.allData[c].data[d].content+"'><span onclick='myQuestionaire.edit.deleSelf(event)' class='dele-self'>X</span></div>";break;case"checkbox":b+="<div class='checkboxs'><input type='checkbox'  disabled='disabled'><input type='text' placeholder='多选内容' value='"+a.allData[c].data[d].content+"'><span onclick='myQuestionaire.edit.deleSelf(event)' class='dele-self'>X</span></div>";break;case"textarea":b+="true"==a.allData[c].data[d].status?"<input type='checkbox' checked='checked'><span>此题是否必填</span> <div><textarea cols='20' rows='10' placeholder='请填写你的回答' class='textareas'  disabled='disabled'></textarea></div>":"<input type='checkbox' ><span>此题是否必填</span> <div><textarea cols='20' rows='10' placeholder='请填写你的回答' class='textareas'  disabled='disabled'></textarea></div>"}switch(a.allData[c].type){case"radio":case"checkbox":b+="</div><div class='add-line'><span onclick='myQuestionaire.edit.newLine(event)'>++++++++++++</span></div><div class='tool-line'><span onclick='myQuestionaire.edit.moveUp(event)'>上移</span><span onclick='myQuestionaire.edit.moveDown(event)'>下移</span><span onclick='myQuestionaire.edit.copy(event)'>复用</span><span onclick='myQuestionaire.edit.deleQuestion(event)'>删除</span></div></div>";break;case"textarea":b+="</div><div class='tool-line'><span onclick='myQuestionaire.edit.moveUp(event)'>上移</span><span onclick='myQuestionaire.edit.moveDown(event)'>下移</span><span onclick='myQuestionaire.edit.copy(event)'>复用</span><span onclick='myQuestionaire.edit.deleQuestion(event)'>删除</span></div></div>"}}document.getElementById("page_subject").value=this.requestInfo,document.getElementById("edit-qbox").innerHTML=b,document.getElementsByClassName("date")[0].value=a.date},topPart:function(a){var c,b=document.createElement("div");switch(a){case"radio":b.className="radio",c="<span></span><span>单选题</span><input type='text' class='subject' placeholder='单选标题'>",b.innerHTML=c;break;case"checkbox":b.className="checkbox",c="<span></span><span>多选题</span><input type='text' class='subject' placeholder='多选标题'>",b.innerHTML=c;break;case"textarea":b.className="textarea",c="<span></span><span>文本题</span><input type='text' class='subject' placeholder='文本标题'>",b.innerHTML=c}return b},middlePart:function(a,b){var d,c=document.createElement("div");switch(a){case"radio":return d="<div class='radios'><input type='radio' name='radio"+b+"' disabled><input type='text' placeholder='单选内容' ><span onclick='myQuestionaire.edit.deleSelf(event)' class='dele-self'>X</span></div>",c.innerHTML=d,c;case"checkbox":return d="<div class='checkboxs'><input type='checkbox' disabled' /><input type='text' placeholder='多选内容'><span onclick='myQuestionaire.edit.deleSelf(event)' class='dele-self'>X</span></div>",c.innerHTML=d,c;case"textarea":return d="<input type='checkbox'><span>此题是否必填</span><div><textarea cols='20' rows='10' disabled class='textareas'></textarea></div>",c.innerHTML=d,c}},bottomPart:function(){var b,a=document.createElement("div");return a.setAttribute("class","tool-line"),b="<span onclick='myQuestionaire.edit.moveUp(event)'>上移</span><span onclick='myQuestionaire.edit.moveDown(event)'>下移</span><span onclick='myQuestionaire.edit.copy(event)'>复用</span><span onclick='myQuestionaire.edit.deleQuestion(event)'>删除</span>",a.innerHTML=b,a},addPart:function(){var b,a=document.createElement("div");return a.setAttribute("class","add-line"),b="<span onclick='myQuestionaire.edit.newLine(event)'>++++++++++++</span>",a.innerHTML=b,a},newRadio:function(){var a=Math.random(),b=document.createElement("div");b.className="questions",b.appendChild(this.topPart("radio")),b.appendChild(this.middlePart("radio",a)),b.appendChild(this.addPart()),b.appendChild(this.bottomPart()),document.getElementById("edit-qbox").appendChild(b),myQuestionaire.edit.queueUp()},newCheckbox:function(){var a=document.createElement("div");a.className="questions",a.appendChild(this.topPart("checkbox")),a.appendChild(this.middlePart("checkbox")),a.appendChild(this.addPart()),a.appendChild(this.bottomPart()),document.getElementById("edit-qbox").appendChild(a),myQuestionaire.edit.queueUp()},newTextarea:function(){var a=document.createElement("div");a.className="questions",a.appendChild(this.topPart("textarea")),a.appendChild(this.middlePart("textarea")),a.appendChild(this.bottomPart()),document.getElementById("edit-qbox").appendChild(a),myQuestionaire.edit.queueUp()},newLine:function(a){var e,f,b=a||window.event,c=b.target||b.srcElement,d=document.createElement("div");switch(this.getQuestionType(c)){case"radio":f=c.parentNode.previousElementSibling.firstElementChild.firstElementChild.name,e="<input type='radio' name='"+f+"' disabled><input type='text' placeholder='单选内容' ><span onclick='myQuestionaire.edit.deleSelf(event)' class='dele-self'>X</span>",d.className="radios";break;case"checkbox":e="<input type='checkbox' disabled'><input type='text' placeholder='多选内容'><span onclick='myQuestionaire.edit.deleSelf(event)' class='dele-self'>X</span>",d.className="checkboxs"}d.innerHTML=e,c.parentNode.previousSibling.appendChild(d)},deleSelf:function(a){var b=a||window.event,c=b.target||b.srcElement,d=c.parentNode,e=d.parentNode;1!=e.getElementsByTagName("div").length&&e.removeChild(d)},saveObj:function(){var a,b,c,e,d,f,g,h,i,j;for(this.info={},this.data=[],a=document.getElementsByClassName("questions"),b=0;b<a.length;b++)switch(c={name:"",type:"",subject:"",data:[]},c.name=a[b].firstElementChild.firstElementChild.innerHTML,c.type=a[b].firstElementChild.className,c.subject=a[b].getElementsByClassName("subject")[0].value.trim(),d={},c.type){case"radio":for(f=a[b].getElementsByClassName("radios"),g=Math.random(),e=0;e<f.length;e++)d={status:0,content:"",count:0,randomNumberId:g},d.status=f[e].firstElementChild.checked?"checked":"",d.content=f[e].firstElementChild.nextElementSibling.value,c.data.push(d);this.data.push(c);break;case"checkbox":for(h=a[b].getElementsByClassName("checkboxs"),e=0;e<h.length;e++)d={status:0,content:"",count:0},d.status=h[e].firstElementChild.checked?"checked":"",d.content=h[e].firstElementChild.nextElementSibling.value,c.data.push(d);this.data.push(c);break;case"textarea":i=a[b].getElementsByTagName("textarea")[0],d={status:0,content:"",count:0},d.status=i.parentNode.previousElementSibling.previousElementSibling.checked?"true":"false",d.content=i.value,c.data.push(d),this.data.push(c)}j=document.getElementById("page_subject").value,this.info.subject=this.trim(j,"g"),this.info.allData=this.data,this.info.date=document.querySelector("[data-calendar]").value,document.getElementById("limitedDate").innerHTML=document.querySelector("[data-calendar]").value,this.info.count=0,this.info.time=this.getCurrentTime().time},trim:function(a,b){var c;return c=a.replace(/(^\s+)|(\s+$)/g,""),"g"==b.toLowerCase()&&(c=c.replace(/\s/g,"")),c},save:function(){this.saveObj(),this.isDateChoose()&&(this.info.state="-1",this.addDataToDB(this.requestInfo),alert("保存成功"))},confirmPost:function(){this.saveObj();var a=document.getElementById("maskControl").className;document.getElementById("maskControl").className="show"===a?"hide":"show"},post:function(){this.saveObj(),this.isDateChoose()&&this.isRightNum()&&(document.getElementById("maskControl").className="hide",this.info.state="0",this.addDataToDB(this.requestInfo),alert("发布成功,1秒后自动跳转到主页。"),setTimeout(function(){window.location.href="index.html"},2e3))},isRightNum:function(){var a=this.info.allData.length;return 1>a||a>10?(alert("问题数量，至少一个，最多十个才能发布，请重新填写！"),this.confirmPost(),!1):!0},isDateChoose:function(){return""===this.info.date?(alert("必须选择一个日期！"),!1):!0},moveUp:function(a){var e,b=a||window.event,c=b.target.parentNode.parentNode,d=c.previousElementSibling;null!==d?(e=c.cloneNode(!0),c.parentNode.removeChild(c),d.parentNode.insertBefore(e,d)):alert("移到头了！"),this.queueUp()},queueUp:function(){var b,c,a=document.getElementById("edit-qbox");for(c=0;c<a.children.length;c++)b=c+1,a.children[c].firstElementChild.firstElementChild.innerHTML="Q"+b},moveDown:function(a){var f,b=a||window.event,c=b.target||b.srcElement,d=c.parentNode.parentNode,e=d.nextElementSibling;null!==e?(f=d.cloneNode(!0),d.parentNode.removeChild(d),e.parentNode.insertBefore(f,e.nextElementSibling)):alert("移到头了！"),this.queueUp()},copy:function(a){var g,h,i,b=a||window.event,c=b.target||b.srcElement,d=c.parentNode.parentNode,e=d.cloneNode(!0),f="Q"+this.getQuestionRank(a);if(e.firstElementChild.firstChild.innerHTML=f,g=Math.random(),"radio"==e.firstElementChild.className)for(h=e.getElementsByClassName("radios"),i=0;i<h.length;i++)e.getElementsByClassName("radios")[i].firstElementChild.name="radio"+g;d.parentNode.appendChild(e)},deleQuestion:function(a){var b=a||window.event,c=b.target||b.srcElement,d=c.parentNode.parentNode;d.parentNode.removeChild(d),this.queueUp()},getQuestionRank:function(){return document.getElementById("edit-qbox").children.length+1},getQuestionType:function(a){return a.parentNode.parentNode.firstElementChild.className},getCurrentTime:function(){var a=new Date,b=a.getFullYear(),c=a.getMonth(),d=a.getDate(),e=a.getHours(),f=a.getMinutes(),g=a.getSeconds(),h=a.getDay(),i=a.getTime();return{year:b,month:c,date:d,hour:e,minute:f,second:g,day:h,time:i}},addDataToDB:function(){var b,a=indexedDB.open("Questionaire",1);a.onerror=function(a){alert("创建/打开数据库失败，失败MSG："+a.target.error.message)},b=this,a.onsuccess=function(a){var c=a.target.result,d=c.transaction("myQuestionaire","readwrite");store=d.objectStore("myQuestionaire"),store.put({count:b.info.count,subject:b.info.subject,date:b.info.date,state:b.info.state,allData:b.info.allData,time:b.info.time})}},toggleShowBtn:function(a){var b=a||window.event,c=b.target||b.srcElement;c.parentNode.firstElementChild.className="hide"==c.parentNode.firstElementChild.className?"show":"hide"}}},-1!=navigator.appName.indexOf("Microsoft Internet Explorer")&&document.all&&"-1"==navigator.userAgent.split(";")[1].toLowerCase().indexOf("msie 10.0")&&(alert("IE9及以下版本浏览器不兼容，为了您的体验请更换其他高级浏览器(Chrome/Firefox/Edge/Safiri等等)再尝试！2秒后自动前往我的主页。"),setTimeout(function(){window.location.href="http://pkjy.github.io"},2e3));var myQuestionaire=new Questionaire;